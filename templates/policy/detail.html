{% extends "base.html" %}
{% set title = "Policy Detail" %}

{% macro render_comment(comment, level=0) %}
<div class="comment" style="margin-left: {{ level * 20 }}px">

    {% if comment.ai_generated %}
    <div class="ai-comment">
        ü§ñ <strong>AI Assistant</strong>
        <p>{{ comment.content }}</p>
    </div>
{% else %}
    <p>{{ comment.content }}</p>
{% endif %}


    <small>Posted at {{ comment.created_at }}</small>

    <form method="POST"
          action="{{ url_for('rep_policy.comment', post_id=post.id) }}">
        <input type="hidden" name="parent_comment_id" value="{{ comment.id }}">
        <textarea name="content" rows="2" placeholder="Reply..." required></textarea>
        <button class="btn-secondary">Reply</button>
    </form>

    {% for reply in comment.replies %}
        {{ render_comment(reply, level + 1) }}
    {% endfor %}
</div>
{% endmacro %}

{% block content %}
{% set first_role = post.created_by_role %}
{% set second_role = "OPPOSITION_REP" if first_role == "ELECTED_REP" else "ELECTED_REP" %}
<div class="policy-detail">

    <h2>üìú {{ post.title if post.title else "Public Forum Discussion" }}</h2>

    <div class="policy-meta">
        <strong>{{ post.author_name }}</strong>

        {% if post.party_name %}
            <span class="party-badge">‚Ä¢ {{ post.party_name }}</span>
        {% endif %}

        <span class="post-time">‚Ä¢ Posted {{ post.created_at }}</span>
    </div>

    <!-- ======================
         Representative Section
    ======================= -->
<section class="policy-section">

    {% if first_role == "ELECTED_REP" %}
        <h3>üèõÔ∏è Representative Position</h3>

        {% if post.image_urls %}
        <div class="policy-images">
            {% for img in post.image_urls %}
                <img src="{{ img }}" class="policy-image">
            {% endfor %}
        </div>
        {% endif %}

        {% if post.representative_statement %}
            <p>{{ post.representative_statement }}</p>
        {% else %}
            <p><em>No representative statement yet.</em></p>
        {% endif %}

    {% else %}
        <h3>‚öñÔ∏è Opposition Position</h3>

        {% if post.image_urls %}
        <div class="policy-images">
            {% for img in post.image_urls %}
                <img src="{{ img }}" class="policy-image">
            {% endfor %}
        </div>
        {% endif %}

        {% if post.opposition_statement %}
            <p>{{ post.opposition_statement }}</p>
        {% else %}
            <p><em>No opposition statement yet.</em></p>
        {% endif %}

    {% endif %}

</section>


    <!-- ======================
         Counter Statement Form
    ======================= -->
        <section class="policy-section">

    {% if second_role == "ELECTED_REP" %}
        <h3>üèõÔ∏è Representative Response</h3>

        {% if post.representative_statement and first_role != "ELECTED_REP" %}
            {% if post.counter_image_urls %}
    {% for img in post.counter_image_urls %}
        <img src="{{ img }}" class="policy-image">
    {% endfor %}
{% endif %}

            <p>{{ post.representative_statement }}</p>
        {% elif session.role == "ELECTED_REP" %}
            <div class="empty-state">
                <p><em>You have not added your official response yet.</em></p>

                <form method="POST"
                      action="{{ url_for('rep_policy.counter_statement', post_id=post.id) }}" enctype="multipart/form-data">
                    <textarea name="content" rows="4" required
                              placeholder="Present the representative‚Äôs response..."></textarea>
                              <label>Upload Supporting Images (optional)</label>
<input type="file" name="images" multiple accept="image/*">
                    <button class="btn-primary">Submit Response</button>
                </form>
            </div>
        {% else %}
            <p><em>Representative response not submitted yet.</em></p>
        {% endif %}

    {% else %}
        <h3>‚öñÔ∏è Opposition Response</h3>

        {% if post.opposition_statement and first_role != "OPPOSITION_REP" %}
        {% if post.counter_image_urls %}
    {% for img in post.counter_image_urls %}
        <img src="{{ img }}" class="policy-image">
    {% endfor %}
{% endif %}

            <p>{{ post.opposition_statement }}</p>
        {% elif session.role == "OPPOSITION_REP" %}
            <div class="empty-state">
                <p><em>You have not added your official opposition response yet.</em></p>

                <form method="POST"
                      action="{{ url_for('rep_policy.counter_statement', post_id=post.id) }}" enctype="multipart/form-data">
                    <textarea name="content" rows="4" required
                              placeholder="Present the opposition‚Äôs response..."></textarea>
                              <label>Upload Supporting Images (optional)</label>
<input type="file" name="images" multiple accept="image/*">
                    <button class="btn-primary">Submit Opposition Response</button>
                </form>
            </div>
        {% else %}
            <p><em>Opposition response not submitted yet.</em></p>
        {% endif %}

    {% endif %}

</section>


    <!-- ======================
         Voting
    ======================= -->
    <div class="policy-voting">
        <form method="POST" action="{{ url_for('rep_policy.vote', post_id=post.id) }}">
            <button name="vote" value="1">üëç Upvote</button>
            <button name="vote" value="-1">üëé Downvote</button>
        </form>

        <p>
            üëç {{ post.upvotes }} |
            üëé {{ post.downvotes }}
        </p>
    </div>

     <div class="ai-summary-box">

    <h4>ü§ñ AI Summary & Fact Check</h4>

    {% if post.ai_summary %}
        <p class="ai-summary-text">
            {{ post.ai_summary }}
        </p>

        {% set fc = post.ai_fact_check %}

        <!-- Representative Claims -->
        {% if fc.representative_claims %}
        <div class="ai-claims rep-claims">
            <h5>üèõÔ∏è Representative Claims</h5>
            <ul>
                {% for item in fc.representative_claims %}
                    <li>
                        <strong>{{ item.claim }}</strong><br>
                        <small>{{ item.note }}</small>
                        <span class="claim-tag {{ item.type | lower | replace(' ', '-') }}">
                            {{ item.type }}
                        </span>
                    </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <!-- Opposition Claims -->
        {% if fc.opposition_claims %}
        <div class="ai-claims opp-claims">
            <h5>‚öñÔ∏è Opposition Claims</h5>
            <ul>
                {% for item in fc.opposition_claims %}
                    <li>
                        <strong>{{ item.claim }}</strong><br>
                        <small>{{ item.note }}</small>
                        <span class="claim-tag {{ item.type | lower | replace(' ', '-') }}">
                            {{ item.type }}
                        </span>
                    </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <!-- Neutral Observations -->
        {% if fc.neutral_observations %}
        <div class="ai-neutral">
            <h5>‚öñÔ∏è Neutral Observations</h5>
            <ul>
                {% for obs in fc.neutral_observations %}
                    <li>{{ obs }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <!-- Confidence -->
        <div class="ai-confidence">
            <strong>AI Confidence:</strong>
            {{ post.ai_confidence_score }}%
        </div>

        <p class="ai-disclaimer">
            ‚ÑπÔ∏è This summary is AI-generated to assist understanding.
            It does not represent an official judgment.
        </p>

    {% else %}
        <p><em>AI analysis will appear once both sides respond.</em></p>
    {% endif %}

</div>

    <a href="{{ url_for('rep_policy.policy_feed') }}">
        ‚Üê Back to Policy Feed
    </a>

</div>
<hr>

<h3>üí¨ Discussion</h3>

<form method="POST" action="{{ url_for('rep_policy.comment', post_id=post.id) }}">
    <textarea name="content" rows="3" placeholder="Add a comment..." required></textarea>
    <button class="btn-primary">Comment</button>
</form>

{% if comments %}
    {% for comment in comments %}
        {{ render_comment(comment) }}
    {% endfor %}
{% else %}
    <p>No comments yet.</p>
{% endif %}

{% endblock %}

